package:
  patterns:
    - '!*.spec.js'
    - '!*.yml'
    - '!serverless.yml'
  individually: true
params:
  default:
    AWS_ACCOUNT_ID: ${env:AWS_ACCOUNT_ID}
    API_KEY: ${env:API_KEY}
    DB_URI: ${env:DB_URI}
    EVENT_BUS_ARN: ${env:EVENT_BUS_ARN}
    GIT_SHA: ${env:GIT_SHA , ''}
    GIT_BRANCH: ${env:GIT_BRANCH, ''}
    DEPLOY_TIME: ${env:DEPLOY_TIME, ''}
    DATADOG_API_KEY: ${env:DATADOG_API_KEY}
    DD_PROFILING_ENABLED: ${env:DD_PROFILING_ENABLED}
    LOG_LEVEL: ${env:LOG_LEVEL}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}

provider:
  name: aws
  runtime: nodejs14.x
  endpointType: regional
  region: ${env:AWS_REGION, 'us-east-1'}
  memorySize: 512 # Overwrite the default memory size. Default is 1024..
  versionFunctions: false # Stops saving a complete version of each function each time its deployed
  iam:
    role: arn:aws:iam::${param:AWS_ACCOUNT_ID}:role/lambda-with-s3
  deploymentBucket:
    name: serverless-${sls:stage} # Deployment bucket name. Default is generated by the framework
    maxPreviousDeploymentArtifacts: 2 # On every deployment the framework prunes the bucket to remove artifacts older than this limit. The default is 5
    blockPublicAccess: true
  apiGateway:
    disableDefaultEndpoint: true
    restApiId: djjet7c19c
    restApiRootResourceId: 8pvtdr6jf8
  logRetentionInDays: 14
  vpc:
    securityGroupIds:
      - sg-003944df4a4cf5dc1
    subnetIds:
      - subnet-09deec82cfc928258
      - subnet-0da51d1d204b5f166
      - subnet-03c495daa2f53e935
  tags:
    version: ${param:GIT_SHA}
    branch: ${param:GIT_BRANCH}
    deploy_time: ${param:DEPLOY_TIME}
    stage: ${sls:stage}
    service: ac-service-${sls:stage}-${self:service}
    'git.commit.sha': ${param:GIT_SHA}
    'git.repository_url': https://github.com/denimsocial/denimsocial-ac-service

plugins:
  - serverless-bundle
  - serverless-add-api-key
  - serverless-plugin-datadog
custom:
  bundle:
    status: true
    linting: false
    minifyOptions:
      keepNames: true
    sourceMaps: true
    caching: true
    excludeFiles: ['**/*.spec.js', '**/mock*.js']
    disableForkTsChecker: true
    esbuild: true
    externals:
      - mongoose
      - datadog-lambda-js
      - graphql-compose-mongoose
      - graphql-compose
      - graphql
  apiKeys:
    - name: template-lambda-service-api-key
      value: ${param:API_KEY}
  offline:
    allowCache: true # Important: This will prevent serverless-offline from eating all of your memory
  datadog:
    addLayers: true
    enableDDTracing: false
    version: 1.0.0
    site: datadoghq.com
    # captureLambdaPayload: false
    # subscribeToApiGatewayLogs: false
    # subscribeToHttpApiLogs: false
    # subscribeToWebsocketLogs: false
    # exclude:
    #   - serviceName
